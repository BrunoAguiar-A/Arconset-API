// üìÅ src/hooks/useSecureBankMonitor.js - VERS√ÉO CORRIGIDA SEM LOOP INFINITO
import { useState, useCallback, useEffect, useRef } from 'react';
import { useAuth } from './useAuth';

// üîß Configura√ß√µes finais - CORRIGIDAS PARA EVITAR LOOPS
const CONFIG = {
  API_BASE: 'http://localhost:5000/api',
  CACHE_TTL: 300000, // 5 minutos
  DEBOUNCE_TIME: 5000, // üö® AUMENTADO: 5 segundos
  AUTO_INIT_ENABLED: false, // üö® NOVO: Desabilitar inicializa√ß√£o autom√°tica
  HEALTH_CHECK_ENABLED: false, // üö® NOVO: Desabilitar health checks autom√°ticos
  MAX_RETRIES: 2, // üö® NOVO: M√°ximo de tentativas
  REQUEST_TIMEOUT: 10000 // üö® NOVO: Timeout de 10 segundos
};

// üîê SINGLETON GLOBAL R√çGIDO - MELHORADO
const GlobalBankMonitor = {
  instance: null,
  cache: {
    configs: null,
    timestamp: 0
  },
  isActive: false,
  lastRequest: 0,
  requestCount: 0, // üö® NOVO: Contador de requisi√ß√µes
  isInitialized: false // üö® NOVO: Flag de inicializa√ß√£o
};

// üè¶ Hook com controle total de inst√¢ncia - CORRIGIDO
export const useSecureBankMonitor = () => {
  // üîê Auth context
  const { isAuthenticated, token } = useAuth();
  
  // üìä Estados principais
  const [boletos, setBoletos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [ultimaVerificacao, setUltimaVerificacao] = useState(null);
  const [statusBancos, setStatusBancos] = useState({
    BRADESCO: { conectado: false, erro: null, totalBoletos: 0 },
    ITAU: { conectado: false, erro: null, totalBoletos: 0 },
    BANCO_BRASIL: { conectado: false, erro: null, totalBoletos: 0 }
  });
  const [bancosConfigurados, setBancosConfigurados] = useState({
    BRADESCO: false,
    ITAU: false,
    BANCO_BRASIL: false
  });
  const [isSecure, setIsSecure] = useState(false);
  const [userBankProfile, setUserBankProfile] = useState(null);

  // üîß Referencias
  const mountedRef = useRef(true);
  const instanceRef = useRef(Math.random().toString(36).substr(2, 9));
  const retryCountRef = useRef(0);

  // üõ°Ô∏è Request √∫nica e controlada - MELHORADA COM MAIS CONTROLES
  const makeControlledRequest = useCallback(async (endpoint, options = {}) => {
    // üö® VERIFICA√á√ÉO ADICIONAL: Se sistema est√° desabilitado
    if (!CONFIG.HEALTH_CHECK_ENABLED && endpoint.includes('health')) {
      console.log('üö® Health check desabilitado, pulando requisi√ß√£o');
      return null;
    }

    // Verifica√ß√µes rigorosas
    if (!isAuthenticated || !token || !mountedRef.current) {
      console.log('‚ùå Request cancelada: n√£o autenticado ou componente desmontado');
      return null;
    }

    // üö® NOVO: Controle de rate limiting
    GlobalBankMonitor.requestCount++;
    if (GlobalBankMonitor.requestCount > 10) {
      console.log('üö® Rate limit atingido, cancelando requisi√ß√£o');
      return null;
    }

    // Controle de frequ√™ncia global (debounce) - AUMENTADO
    const now = Date.now();
    if (now - GlobalBankMonitor.lastRequest < CONFIG.DEBOUNCE_TIME) {
      console.log('‚è≥ Request cancelada: debounce global ativo');
      return null;
    }

    // Apenas uma inst√¢ncia pode fazer requisi√ß√µes
    if (GlobalBankMonitor.instance && GlobalBankMonitor.instance !== instanceRef.current) {
      console.log('üîí Request cancelada: outra inst√¢ncia √© dona das requisi√ß√µes');
      return null;
    }

    // Marcar como inst√¢ncia ativa
    if (!GlobalBankMonitor.instance) {
      GlobalBankMonitor.instance = instanceRef.current;
      console.log(`üîë Inst√¢ncia ${instanceRef.current} assumiu controle`);
    }

    GlobalBankMonitor.lastRequest = now;

    try {
      console.log(`üîê Fazendo requisi√ß√£o controlada: ${endpoint}`);

      // üö® NOVO: Controller para timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), CONFIG.REQUEST_TIMEOUT);

      const response = await fetch(`${CONFIG.API_BASE}${endpoint}`, {
        method: 'GET',
        headers: {
          Accept: 'application/json',
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
        credentials: 'include',
        signal: controller.signal, // üö® NOVO: Abort signal
        ...options
      });

      clearTimeout(timeoutId);

      if (!response.ok) {
        const errorText = await response.text();
        console.error(`‚ùå Erro HTTP ${response.status}:`, errorText);

        if (response.status === 401) {
          // Token inv√°lido ou expirado: limpar e logout
          GlobalBankMonitor.instance = null;
          console.warn('‚ùå Token inv√°lido ou expirado detectado.');
          
          // üö® N√ÉO FAZER LOGOUT AUTOM√ÅTICO - APENAS LOG
          console.log('‚ö†Ô∏è Token expirado, mas mantendo sess√£o local');
          return null;
        }

        throw new Error(`HTTP ${response.status}: ${errorText}`);
      }

      const data = await response.json();
      console.log(`‚úÖ Sucesso: ${endpoint}`);
      
      // üö® NOVO: Reset contador ap√≥s sucesso
      GlobalBankMonitor.requestCount = Math.max(0, GlobalBankMonitor.requestCount - 1);
      retryCountRef.current = 0;
      
      return data;
    } catch (error) {
      console.error(`‚ùå Erro na requisi√ß√£o ${endpoint}:`, error);
      
      // üö® NOVO: Controle de retry
      retryCountRef.current++;
      if (retryCountRef.current >= CONFIG.MAX_RETRIES) {
        GlobalBankMonitor.instance = null;
        console.log('üö® M√°ximo de tentativas atingido, liberando inst√¢ncia');
      }
      
      // üö® NOVO: Se for timeout, n√£o considerar erro cr√≠tico
      if (error.name === 'AbortError') {
        console.warn('‚è∞ Requisi√ß√£o cancelada por timeout');
        return null;
      }
      
      throw error;
    }
  }, [isAuthenticated, token]);

  // üìã Carregar configura√ß√µes com cache rigoroso - CORRIGIDA
  const carregarConfiguracoes = useCallback(async () => {
    // üö® VERIFICA√á√ÉO ADICIONAL: Se auto-init est√° desabilitado
    if (!CONFIG.AUTO_INIT_ENABLED) {
      console.log('üìã Auto-init desabilitado, usando valores padr√£o');
      if (mountedRef.current) {
        setBancosConfigurados({
          BRADESCO: false,
          ITAU: false,
          BANCO_BRASIL: false
        });
        setUserBankProfile({
          configured_banks: [],
          total_banks: 3,
          active_banks: 0
        });
        setIsSecure(false);
      }
      return;
    }

    try {
      const now = Date.now();

      // Usar cache se ainda v√°lido
      if (
        GlobalBankMonitor.cache.configs &&
        (now - GlobalBankMonitor.cache.timestamp) < CONFIG.CACHE_TTL
      ) {
        console.log('üìã Usando cache de configura√ß√µes');
        if (mountedRef.current) {
          const cached = GlobalBankMonitor.cache.configs;
          setBancosConfigurados(cached.bancosConfigurados);
          setUserBankProfile(cached.userBankProfile);
          setIsSecure(cached.isSecure);
        }
        return; // Sai aqui pra n√£o fazer nova requisi√ß√£o
      }

      // üö® VERIFICA√á√ÉO: Se j√° est√° carregando, n√£o fazer nova requisi√ß√£o
      if (loading) {
        console.log('üìã J√° est√° carregando configura√ß√µes, pulando...');
        return;
      }

      // Cache expirou ou n√£o existe, faz requisi√ß√£o
      console.log('üîç Carregando configura√ß√µes banc√°rias...');
      const result = await makeControlledRequest('/bank-config');

      // Se n√£o recebeu dados v√°lidos, s√≥ loga e sai (sem sobrescrever cache nem estado)
      if (!result || !result.success) {
        console.warn('‚ö†Ô∏è Resposta inv√°lida ou erro no servidor:', result);
        return;
      }

      // Montar novo status dos bancos
      const novoStatus = {};
      const configuredBanks = [];

      if (result.configs) {
        Object.entries(result.configs).forEach(([banco, config]) => {
          const hasCredentials = Boolean(config?.hasCredentials);
          novoStatus[banco] = hasCredentials;

          if (hasCredentials) {
            configuredBanks.push(banco);
          }
        });
      }

      const profileData = {
        configured_banks: configuredBanks,
        total_banks: Object.keys(novoStatus).length,
        active_banks: configuredBanks.length
      };

      const isSecureStatus = configuredBanks.length > 0;

      // Atualiza cache global com timestamp novo
      GlobalBankMonitor.cache = {
        configs: {
          bancosConfigurados: novoStatus,
          userBankProfile: profileData,
          isSecure: isSecureStatus
        },
        timestamp: now
      };

      // Atualiza estados s√≥ se componente ainda montado
      if (mountedRef.current) {
        setBancosConfigurados(novoStatus);
        setUserBankProfile(profileData);
        setIsSecure(isSecureStatus);
        setError(null); // Limpa erro se tiver
      }

      console.log('‚úÖ Configura√ß√µes carregadas com sucesso:', novoStatus);

    } catch (error) {
      console.error('‚ùå Erro ao carregar configura√ß√µes:', error);
      if (mountedRef.current) {
        setError(error.message || 'Erro desconhecido');
      }
    }
  }, [makeControlledRequest, loading]);

  // üîÑ Verificar boletos APENAS quando solicitado - CORRIGIDA
  const verificarTodosBoletos = useCallback(async () => {
    if (!isAuthenticated || !mountedRef.current || loading) {
      console.log('‚ùå Verifica√ß√£o cancelada: pr√©-condi√ß√µes n√£o atendidas');
      return;
    }

    console.log('üîÑ Verifica√ß√£o manual de boletos...');
    setLoading(true);
    setError(null);

    try {
      // üö® N√ÉO CARREGAR CONFIGURA√á√ïES AUTOMATICAMENTE
      // await carregarConfiguracoes();
      
      // Por enquanto, simular verifica√ß√£o sem boletos reais
      if (mountedRef.current) {
        setBoletos([]);
        setUltimaVerificacao(new Date().toISOString());
        console.log('‚úÖ Verifica√ß√£o conclu√≠da: sistema configurado mas sem boletos reais');
      }
      
    } catch (error) {
      console.error('‚ùå Erro ao verificar boletos:', error);
      if (mountedRef.current) {
        setError(error.message);
      }
    } finally {
      if (mountedRef.current) {
        setLoading(false);
      }
    }
  }, [isAuthenticated, loading]);

  // üìä Calcular estat√≠sticas - MANTIDA
  const getEstatisticas = useCallback(() => {
    return {
      total: boletos.length,
      urgentes: boletos.filter(b => b.urgente).length,
      pendentes: boletos.filter(b => b.status === 'Pendente').length,
      valorTotal: boletos.reduce((sum, b) => sum + (b.valor || 0), 0),
      porBanco: { 
        bradesco: boletos.filter(b => b.banco === 'BRADESCO').length,
        itau: boletos.filter(b => b.banco === 'ITAU').length,
        bb: boletos.filter(b => b.banco === 'BANCO_BRASIL').length
      }
    };
  }, [boletos]);

  // üö® NOVA FUN√á√ÉO: Inicializa√ß√£o manual
  const manualInit = useCallback(async () => {
    if (!isAuthenticated || loading) {
      console.log('‚ùå Inicializa√ß√£o manual cancelada: n√£o autenticado ou carregando');
      return;
    }

    console.log('üöÄ Inicializa√ß√£o manual do monitor banc√°rio...');
    
    // Temporariamente habilitar auto-init para esta execu√ß√£o
    const originalEnabled = CONFIG.AUTO_INIT_ENABLED;
    CONFIG.AUTO_INIT_ENABLED = true;
    
    try {
      await carregarConfiguracoes();
      GlobalBankMonitor.isInitialized = true;
    } catch (error) {
      console.error('‚ùå Erro na inicializa√ß√£o manual:', error);
    } finally {
      CONFIG.AUTO_INIT_ENABLED = originalEnabled;
    }
  }, [carregarConfiguracoes, isAuthenticated, loading]);

  // üö® NOVA FUN√á√ÉO: Reset completo
  const resetMonitor = useCallback(() => {
    console.log('üîÑ Reset completo do monitor banc√°rio...');
    
    // Limpar cache global
    GlobalBankMonitor.cache = {
      configs: null,
      timestamp: 0
    };
    GlobalBankMonitor.instance = null;
    GlobalBankMonitor.requestCount = 0;
    GlobalBankMonitor.isInitialized = false;
    
    // Reset estados locais
    if (mountedRef.current) {
      setBoletos([]);
      setError(null);
      setUltimaVerificacao(null);
      setBancosConfigurados({
        BRADESCO: false,
        ITAU: false,
        BANCO_BRASIL: false
      });
      setUserBankProfile(null);
      setIsSecure(false);
    }
    
    console.log('‚úÖ Reset completo conclu√≠do');
  }, []);

  // üöÄ INICIALIZA√á√ÉO √öNICA E CONTROLADA - CORRIGIDA
  useEffect(() => {
    // üö® VERIFICA√á√ÉO RIGOROSA: S√≥ executar se todas as condi√ß√µes forem atendidas
    if (!isAuthenticated || !mountedRef.current || !CONFIG.AUTO_INIT_ENABLED || GlobalBankMonitor.isInitialized) {
      console.log('üöÄ Inicializa√ß√£o autom√°tica pulada:', {
        isAuthenticated,
        mounted: mountedRef.current,
        autoInitEnabled: CONFIG.AUTO_INIT_ENABLED,
        isInitialized: GlobalBankMonitor.isInitialized
      });
      return;
    }

    // ‚úÖ DELAY MAIOR PARA EVITAR M√öLTIPLAS INICIALIZA√á√ïES
    const timer = setTimeout(() => {
      if (mountedRef.current && isAuthenticated && CONFIG.AUTO_INIT_ENABLED && !GlobalBankMonitor.isInitialized) {
        console.log(`üöÄ Inicializando monitor banc√°rio (inst√¢ncia: ${instanceRef.current})`);
        GlobalBankMonitor.isInitialized = true;
        carregarConfiguracoes();
      }
    }, 3000); // üö® AUMENTADO: 3 segundos

    return () => {
      clearTimeout(timer);
    };
  }, []); // ‚úÖ ARRAY VAZIO - EXECUTA APENAS UMA VEZ

  // üßπ CLEANUP RIGOROSO - MELHORADO
  useEffect(() => {
    return () => {
      console.log(`üßπ Limpando inst√¢ncia ${instanceRef.current}`);
      mountedRef.current = false;
      
      // ‚úÖ LIBERAR CONTROLE SE FOR A INST√ÇNCIA ATIVA
      if (GlobalBankMonitor.instance === instanceRef.current) {
        GlobalBankMonitor.instance = null;
        console.log(`üîì Inst√¢ncia ${instanceRef.current} liberou controle`);
      }
      
      // üö® NOVO: Reset contador se for a √∫ltima inst√¢ncia
      GlobalBankMonitor.requestCount = Math.max(0, GlobalBankMonitor.requestCount - 1);
    };
  }, []);

  // üîê Fun√ß√£o auxiliar para obter token - MANTIDA
  const getAuthToken = useCallback(() => token, [token]);

  // üö® NOVA FUN√á√ÉO: Verificar status do sistema
  const getSystemStatus = useCallback(() => {
    return {
      isInitialized: GlobalBankMonitor.isInitialized,
      currentInstance: GlobalBankMonitor.instance,
      isControlling: GlobalBankMonitor.instance === instanceRef.current,
      requestCount: GlobalBankMonitor.requestCount,
      lastRequest: GlobalBankMonitor.lastRequest,
      cacheAge: GlobalBankMonitor.cache.timestamp ? Date.now() - GlobalBankMonitor.cache.timestamp : null,
      config: {
        autoInitEnabled: CONFIG.AUTO_INIT_ENABLED,
        healthCheckEnabled: CONFIG.HEALTH_CHECK_ENABLED,
        debounceTime: CONFIG.DEBOUNCE_TIME
      }
    };
  }, []);
  const getBoletosList = useCallback(async (filters = {}) => {
  const { bankName, status } = filters;
  let endpoint = '/bank/boletos';
  
  const params = new URLSearchParams();
  if (bankName && bankName !== 'TODOS') {
    params.append('bankName', bankName);
  }
  if (status && status !== 'TODOS') {
    params.append('status', status);
  }
  
  if (params.toString()) {
    endpoint += `?${params.toString()}`;
  }
  
  const result = await makeControlledRequest(endpoint);
  return result;
}, [makeControlledRequest]);

  // üéØ API p√∫blica do hook - EXPANDIDA
  return {
    // Dados
    boletos,
    loading,
    error,
    ultimaVerificacao,
    statusBancos,
    bancosConfigurados,
    isSecure,
    userBankProfile,
    
    // Fun√ß√µes principais (sob demanda)
    verificarTodosBoletos,
    getEstatisticas,
    getAuthToken,
    getBoletosList,
    
    // üö® NOVAS FUN√á√ïES: Controle manual
    manualInit,
    resetMonitor,
    carregarConfiguracoes: () => {
      const originalEnabled = CONFIG.AUTO_INIT_ENABLED;
      CONFIG.AUTO_INIT_ENABLED = true;
      const result = carregarConfiguracoes();
      CONFIG.AUTO_INIT_ENABLED = originalEnabled;
      return result;
    },
    
    // Status
    isConnected: false, // Por enquanto false at√© ter dados reais
    hasConfiguredBanks: Object.values(bancosConfigurados).some(Boolean),
    totalBanks: Object.keys(bancosConfigurados).length,
    activeBanks: Object.values(bancosConfigurados).filter(Boolean).length,
    
    // Debug e monitoramento
    instanceId: instanceRef.current,
    isControllingInstance: GlobalBankMonitor.instance === instanceRef.current,
    getSystemStatus,
    
    // üö® NOVO: Configura√ß√µes atuais
    config: {
      autoInitEnabled: CONFIG.AUTO_INIT_ENABLED,
      healthCheckEnabled: CONFIG.HEALTH_CHECK_ENABLED,
      debounceTime: CONFIG.DEBOUNCE_TIME,
      maxRetries: CONFIG.MAX_RETRIES,
      requestTimeout: CONFIG.REQUEST_TIMEOUT
    }
  };
};

export default useSecureBankMonitor;